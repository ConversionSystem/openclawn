# Kyra AI - Cloudflare Workers Configuration
# Deploy with: wrangler deploy
# Docs: https://developers.cloudflare.com/workers/wrangler/configuration/

name = "kyra-ai"
main = "src/index.ts"
compatibility_date = "2026-01-29"
compatibility_flags = ["nodejs_compat"]

# Worker settings
[vars]
ENVIRONMENT = "production"
KYRA_VERSION = "1.0.0"
KYRA_NAME = "Kyra"
KYRA_TAGLINE = "Your Intelligent Companion"

# R2 Storage for persistent data (sessions, memory, config)
[[r2_buckets]]
binding = "KYRA_DATA"
bucket_name = "kyra-data"

# KV Namespace for fast config/session lookups
[[kv_namespaces]]
binding = "KYRA_CONFIG"
id = "REPLACE_WITH_KV_NAMESPACE_ID"

# Sandbox Container (Durable Object) for OpenClaw runtime
[[durable_objects.bindings]]
name = "Sandbox"
class_name = "Sandbox"

[[migrations]]
tag = "v1"
new_classes = ["Sandbox"]

# AI Gateway integration (optional but recommended)
# Provides unified billing, caching, fallbacks, and analytics
# [ai]
# binding = "AI"

# Browser Rendering for web automation tasks
# [browser]
# binding = "BROWSER"

# Scheduled tasks
[triggers]
crons = [
  "0 0 1 * *",   # Monthly: Reset usage counters (1st of month, midnight UTC)
  "0 * * * *"   # Hourly: Health check and cleanup
]

# Build configuration
[build]
command = "npm run build"

# Development settings
[dev]
port = 8787
local_protocol = "http"

# ============================================
# ENVIRONMENT-SPECIFIC CONFIGURATIONS
# ============================================

# Staging environment
[env.staging]
name = "kyra-ai-staging"
vars = { ENVIRONMENT = "staging", KYRA_VERSION = "1.0.0-staging" }

[[env.staging.r2_buckets]]
binding = "KYRA_DATA"
bucket_name = "kyra-data-staging"

[[env.staging.kv_namespaces]]
binding = "KYRA_CONFIG"
id = "REPLACE_WITH_STAGING_KV_ID"

# Production environment
[env.production]
name = "kyra-ai"
vars = { ENVIRONMENT = "production", KYRA_VERSION = "1.0.0" }

# Custom domain routing (uncomment and configure)
# routes = [
#   { pattern = "kyra.yourdomain.com/*", zone_name = "yourdomain.com" },
#   { pattern = "api.kyra.yourdomain.com/*", zone_name = "yourdomain.com" }
# ]

[[env.production.r2_buckets]]
binding = "KYRA_DATA"
bucket_name = "kyra-data"

[[env.production.kv_namespaces]]
binding = "KYRA_CONFIG"
id = "REPLACE_WITH_PRODUCTION_KV_ID"

# ============================================
# SECRETS (set via wrangler secret put)
# ============================================
# Required:
#   ANTHROPIC_API_KEY       - Claude API key
#   STRIPE_SECRET_KEY       - Stripe secret key (sk_live_...)
#   STRIPE_WEBHOOK_SECRET   - Stripe webhook signing secret (whsec_...)
#   MOLTBOT_GATEWAY_TOKEN   - Gateway authentication token
#
# Optional:
#   ANTHROPIC_BASE_URL      - AI Gateway URL (for unified billing/caching)
#   CF_ACCESS_TEAM_DOMAIN   - Cloudflare Access team domain
#   CF_ACCESS_AUD           - Cloudflare Access audience tag
#   TELEGRAM_BOT_TOKEN      - Telegram bot token
#   DISCORD_BOT_TOKEN       - Discord bot token
#   SLACK_BOT_TOKEN         - Slack bot token
#   SLACK_APP_TOKEN         - Slack app token
#   SENTRY_DSN              - Sentry error tracking DSN
